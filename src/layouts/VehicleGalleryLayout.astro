---
interface Props {
  pageTitle?: string;
  metaDescription?: string;
  schemaJsonLd?: string;
}

const { pageTitle: titleProp, metaDescription, schemaJsonLd } = Astro.props;
import { splitHeaderHtmlForSlot } from '../lib/inject-slot-into-header';

const [headerResponse, footerResponse] = await Promise.all([
  fetch('https://www.threepiece.us/header-only', { redirect: 'follow' }),
  fetch('https://www.threepiece.us/footer-only', { redirect: 'follow' }),
]);
let headerHtml = headerResponse.ok ? await headerResponse.text() : '';
const footerHtml = footerResponse.ok ? await footerResponse.text() : '';

const pageTitle = titleProp ?? 'Vehicle Gallery | Three Piece';

if (headerHtml.includes('<title>')) {
  headerHtml = headerHtml.replace(/<title>[\s\S]*?<\/title>/i, `<title>${pageTitle}</title>`);
} else {
  headerHtml = headerHtml.replace('</head>', `<title>${pageTitle}</title>\n\t</head>`);
}

if (metaDescription) {
  const metaDescTag = `<meta name="description" content="${metaDescription.replace(/"/g, '&quot;')}" />`;
  headerHtml = headerHtml.replace('</head>', metaDescTag + '\n\t</head>');
}

if (schemaJsonLd) {
  const scriptTag = `<script type="application/ld+json">${schemaJsonLd}</script>`;
  headerHtml = headerHtml.replace('</head>', scriptTag + '\n\t</head>');
}

const { before: headerBefore, after: headerAfter } = splitHeaderHtmlForSlot(headerHtml);
---

<!-- <Fragment set:html={headerBefore} /> -->
<slot />
<Fragment set:html={headerAfter} />
<!-- <Fragment set:html={footerHtml} /> -->
