---
import VehicleGalleryLayout from '../../../layouts/VehicleGalleryLayout.astro';
import { getVehicleSlug } from '../../../lib/vehicle-slug';
import '../vehicle-gallery.scss';

const apiBaseUrl = 'https://threepieceus-api-h83mp.ondigitalocean.app';

const fetchVehicleData = async (vehicleId: string | undefined) => {
  const id = Number(vehicleId);
  if (!id || !Number.isInteger(id)) return null;
  try {
    const response = await fetch(
      `${apiBaseUrl}/fitment-gallery/approved/vehicle/${id}`
    );
    if (!response.ok) return null;
    return await response.json();
  } catch {
    return null;
  }
};

const id = Astro.params.id;
const slug = Astro.params.slug ?? '';

const vehicleData = await fetchVehicleData(id);

if (!vehicleData) {
  return Astro.redirect('/vehicle-gallery/');
}

const canonicalSlug = getVehicleSlug(vehicleData);

if (slug !== canonicalSlug) {
  return Astro.redirect(`/vehicle-gallery/${id}/${canonicalSlug}`);
}

const wheelFinish = vehicleData['wheel-finish'] ?? vehicleData['wheel-finish-name'] ?? '';
const vehicle = [vehicleData?.year, vehicleData?.make, vehicleData?.model].filter(Boolean).join(' ');
const wheels = [vehicleData?.['wheel-brand'], vehicleData?.['wheel-model']].filter(Boolean).join(' ');
const tires = [vehicleData?.['tire-brand'], vehicleData?.['tire-model']].filter(Boolean).join(' ');
const pageTitle = ([vehicle, wheels].filter(Boolean).join(' with ')
  + (wheelFinish ? ` - ${wheelFinish}` : '')
  + (tires ? ` and ${tires}` : '')).trim() || undefined;

const metaDescription = [
  vehicle,
  wheels && `with ${wheels} wheels`,
  wheelFinish && wheelFinish,
  tires && `and ${tires} tires`,
]
  .filter(Boolean)
  .join(' ')
  .trim() + '. View fitment specs, wheel size, offset, and suspension details at Three Piece.';

const baseUrl = 'https://threepiece.us';
const pageUrl = `${baseUrl}/vehicle-gallery/${id}/${canonicalSlug}`;
const imageUrls = [1, 2, 3, 4, 5]
  .map((n) => vehicleData?.[`image-${n}`])
  .filter(Boolean);
const firstImageUrl = imageUrls[0];
const imageNumbers = [1, 2, 3, 4, 5].filter((n) => vehicleData?.[`image-${n}`]);

const nextArrowSvg = `data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='42' viewBox='0 0 24 42'%3E%3Cpath d='M1.45679 1.00746147l21 20.02482143L1.50885 41.0074615' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' fill='none' fill-rule='evenodd' /%3E%3C/svg%3E`;
const prevArrowSvg = `data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='42' viewBox='0 0 24 42'%3E%3Cg transform='translate(24,0) scale(-1,1)'%3E%3Cpath d='M1.45679 1.00746147l21 20.02482143L1.50885 41.0074615' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' fill='none' fill-rule='evenodd' /%3E%3C/g%3E%3C/svg%3E`;

const schemaJsonLd = JSON.stringify({
  '@context': 'https://schema.org',
  '@graph': [
    {
      '@type': 'WebPage',
      name: pageTitle ?? vehicle,
      description: metaDescription,
      url: pageUrl,
      ...(firstImageUrl && {
        primaryImageOfPage: {
          '@type': 'ImageObject',
          url: firstImageUrl,
        },
      }),
      breadcrumb: { '@id': `${pageUrl}#breadcrumb` },
    },
    {
      '@type': 'BreadcrumbList',
      '@id': `${pageUrl}#breadcrumb`,
      itemListElement: [
        { '@type': 'ListItem', position: 1, name: 'Home', item: `${baseUrl}/` },
        { '@type': 'ListItem', position: 2, name: 'Vehicle Gallery', item: `${baseUrl}/vehicle-gallery` },
        { '@type': 'ListItem', position: 3, name: vehicle },
      ],
    },
    {
      '@type': 'Vehicle',
      name: vehicle,
      ...(vehicleData?.year && { vehicleModelDate: Number(vehicleData.year) }),
      ...(vehicleData?.make && { brand: { '@type': 'Brand', name: String(vehicleData.make) } }),
      ...(vehicleData?.model && { model: String(vehicleData.model) }),
      ...(imageUrls.length > 0 && {
        image: imageUrls.map((url) => ({ '@type': 'ImageObject', url })),
      }),
    },
  ],
});
---

<VehicleGalleryLayout pageTitle={pageTitle} metaDescription={metaDescription} schemaJsonLd={schemaJsonLd}>
	<div id="vehicle-gallery-page">
	<div class="container">
		<div>
		  <nav class="breadcrumbs" aria-label="Breadcrumb">
		    <a href="https://threepiece.us/">Home</a>
		    <span class="breadcrumbs-sep" aria-hidden="true">/</span>
		    <a href="https://threepiece.us/vehicle-gallery">Vehicle Gallery</a>
		    <span class="breadcrumbs-sep" aria-hidden="true">/</span>
		    <span class="breadcrumbs-current">{vehicle}</span>
		  </nav>
		  <h1 class="vehicle-title">
			{vehicleData?.year} {vehicleData?.make} {vehicleData?.model}
		  </h1>
		  <h5 class="vehicle-wheel-info">
			{vehicleData?.["wheel-brand"]} {vehicleData?.["wheel-model"]} -{" "}
			{vehicleData?.["tire-brand"]}
			{vehicleData?.["tire-model"]}
		  </h5>	
		</div>
		<div class="vehicle-gallery_container">
		  <div class="vehicle-content">
			<div class="vehicle-slider" id="vehicle-slider" data-slide-count={imageNumbers.length}>
			  <div class="vehicle-slider__track">
				{imageNumbers.map((number) => (
					<div class="vehicle-slider__slide">
						<img
							src={vehicleData?.[`image-${number}`]}
							alt={`${vehicle} - Image ${number}`}
							title={`${vehicle} - Image ${number}`}
							loading={number === 1 ? 'eager' : 'lazy'}
							fetchpriority={number === 1 ? 'high' : undefined}
						/>
					</div>
				))}
			  </div>
			  {imageNumbers.length > 1 && (
			    <>
			      <button type="button" class="vehicle-slider__prev" aria-label="Previous image">
			        <img class="vehicle-slider__arrow" src={prevArrowSvg} alt="" width="10" />
			      </button>
			      <button type="button" class="vehicle-slider__next" aria-label="Next image">
			        <img class="vehicle-slider__arrow" src={nextArrowSvg} alt="" width="10" />
			      </button>
			      <ul class="vehicle-slider__dots" role="tablist" aria-label="Image navigation">
			        {imageNumbers.map((_, i) => (
			          <li role="presentation">
			            <button type="button" class="vehicle-slider__dot" data-index={i} aria-label={`Image ${i + 1}`} aria-selected={i === 0} role="tab"></button>
			          </li>
			        ))}
			      </ul>
			    </>
			  )}
			</div>

			<div class="vehicle-information">
			  <div class="vehicle-tab">
				<div class="tab">
				  <h3>Vehicle</h3>
				</div>
				<div class="content">
				  <h4>
					Year: <span class="year">{vehicleData?.year}</span>
				  </h4>
				  <h4>
					Make: <span class="make">{vehicleData?.make}</span>
				  </h4>
				  <h4>
					Model: <span class="model">{vehicleData?.model}</span>
				  </h4>
				  <h4>
					Owner:{" "}
					<a
					  class="ownerInstagram"
					  target="_blank"
					  rel="nofollow"
					  href={`https://www.instagram.com/${vehicleData?.instagramHandle?.replace?.(
						"@",
						""
					  ) ?? ''}`}
					>
					  {vehicleData?.instagramHandle}
					</a>
				  </h4>
				</div>
			  </div>
			  <div class="wheel-tab">
				<div class="tab">
				  <h3>Wheels</h3>
				</div>
				<div class="content">
				  <div>
					<h3>
					  Front:{" "}
					  <span class="frontWheelSize">
						{vehicleData?.["front-diameter"]}x
						{vehicleData?.["front-width"]}
					  </span>
					</h3>
					<h4>
					  Brand:{" "}
					  <span class="wheelBrand">
						{vehicleData?.["wheel-brand"]}
					  </span>
					</h4>
					<h4>
					  Model:{" "}
					  <span class="wheelModel">
						{vehicleData?.["wheel-model"]}
					  </span>
					</h4>
					<h4>
					  Diameter:{" "}
					  <span class="frontDiameter">
						{vehicleData?.["front-diameter"]}
					  </span>
					</h4>
					<h4>
					  Width:{" "}
					  <span class="frontWidth">
						{vehicleData?.["front-width"]}
					  </span>
					</h4>
					<h4>
					  Offset:{" "}
					  <span class="frontOffset">
						{vehicleData?.["front-offset"]}
					  </span>
					</h4>
				  </div>
				  <div>
					<h3>
					  Rear:{" "}
					  <span class="rearWheelSize">
						{vehicleData?.["rear-diameter"]}x
						{vehicleData?.["rear-width"]}
					  </span>
					</h3>
					<h4>
					  Diameter:{" "}
					  <span class="rearDiameter">
						{vehicleData?.["rear-diameter"]}
					  </span>
					</h4>
					<h4>
					  Width:{" "}
					  <span class="rearWidth">
						{vehicleData?.["rear-width"]}
					  </span>
					</h4>
					<h4>
					  Offset:{" "}
					  <span class="rearOffset">
						{vehicleData?.["rear-offset"]}
					  </span>
					</h4>
				  </div>
				</div>
			  </div>
			  <div class="tire-tab">
				<div class="tab">
				  <h3>Tires</h3>
				</div>
				<div class="content">
				  <div>
					<h3>
					  Front:{" "}
					  <span class="frontTireSize">
						{vehicleData?.["front-tire-size"]}/
						{vehicleData?.["front-aspect-ratio"]}
					  </span>
					</h3>
					<h4>
					  Brand:{" "}
					  <span class="tireBrand">
						{vehicleData?.["tire-brand"]}
					  </span>
					</h4>
					<h4>
					  Model:{" "}
					  <span class="tireModel">
						{vehicleData?.["tire-model"]}
					  </span>
					</h4>
				  </div>
				  <div>
					<h3>
					  Rear:{" "}
					  <span class="rearTireSize">
						{vehicleData?.["rear-tire-size"]}/
						{vehicleData?.["rear-aspect-ratio"]}
					  </span>
					</h3>
					<h4>
					  Brand:{" "}
					  <span class="tireBrand">
						{vehicleData?.["tire-brand"]}
					  </span>
					</h4>
					<h4>
					  Model:{" "}
					  <span class="tireModel">
						{vehicleData?.["tire-model"]}
					  </span>
					</h4>
				  </div>
				</div>
			  </div>
			  <div class="modification-tab">
				<div class="tab">
				  <h3>Modifications</h3>
				</div>
				<div class="content">
				  <div>
					<h4>
					  Suspension:{" "}
					  <span class="suspension">
						{vehicleData?.["suspension-type"]}
					  </span>
					</h4>
					<h4>
					  Stance:{" "}
					  <span class="stanceType">
						{vehicleData?.["stance"]}
					  </span>
					</h4>
					<h4>
					  Rubbing:{" "}
					  <span class="frontRubbing">
						{vehicleData?.["front-rubbing"]}
					  </span>
					</h4>
					<h4>
					  Spacers:{" "}
					  <span class="frontSpacers">
						{vehicleData?.["front-spacer"]}
					  </span>
					</h4>
				  </div>
				  <div>
					<h4>
					  Rubbing:{" "}
					  <span class="rearRubbing">
						{vehicleData?.["rear-rubbing"]}
					  </span>
					</h4>
					<h4>
					  Spacers:{" "}
					  <span class="rearSpacers">
						{vehicleData?.["rear-spacer"]}
					  </span>
					</h4>
				  </div>
				</div>
			  </div>
			</div>
		  </div>
		  <div class="additional-details">
			<div class="additional-details-tab">
			  <div class="tab">
				<h3>Additional Information</h3>
			  </div>
			  <div class="content">
				<p>
				  You're here because you want to know what wheels fit onto a{" "}
				  <span class="yearMakeModel">
					{vehicleData?.["year"]} {vehicleData?.["make"]}{" "}
					{vehicleData?.["model"]}
				  </span>{" "}
				  right? This{" "}
				  <span class="yearMakeModel">
					{vehicleData?.["year"]} {vehicleData?.["make"]}{" "}
					{vehicleData?.["model"]}
				  </span>{" "}
				  is running a set of{" "}
				  <span class="frontDiameter">
					{vehicleData?.["front-diameter"]}
				  </span>
				  x
				  <span class="frontWidth">
					{vehicleData?.["front-width"]}
				  </span>{" "}
				  <span class="frontOffset">
					{vehicleData?.["front-offset"]}
				  </span>{" "}
				  <span class="wheelBrand">
					{vehicleData?.["wheel-brand"]}
				  </span>{" "}
				  <span class="wheelModel">
					{vehicleData?.["wheel-model"]}
				  </span>{" "}
				  and{" "}
				  <span class="rearDiameter">
					{vehicleData?.["rear-diameter"]}
				  </span>
				  x
				  <span class="rearWidth">{vehicleData?.["rear-width"]}</span>{" "}
				  <span class="rearOffset">
					{vehicleData?.["rear-offset"]}
				  </span>{" "}
				  with{" "}
				  <span class="frontTireSize">
					{vehicleData?.["front-tire-size"]}/
					{vehicleData?.["front-aspect-ratio"]}R
				  </span>
				  <span class="frontDiameter">
					{vehicleData?.["front-diameter"]}
				  </span>
				  <span class="tireBrand">
					{" "}
					{vehicleData?.["tire-brand"]}
				  </span>{" "}
				  in the front and{" "}
				  <span class="rearTireSize">
					{vehicleData?.["rear-tire-size"]}/
					{vehicleData?.["rear-aspect-ratio"]}R
				  </span>
				  <span class="rearDiameter">
					{vehicleData?.["rear-diameter"]}
				  </span>{" "}
				  in the rear.
				</p>
				<p>
				  This vehicle is on{" "}
				  <span class="suspension">
					{vehicleData?.["suspension-type"]}
				  </span>{" "}
				  <span class="suspension">
					{vehicleData?.["suspension-brand"]}
				  </span>{" "}
				  and as for spacers, this{" "}
				  <span class="yearMakeModel">
					{vehicleData?.["year"]} {vehicleData?.["make"]}{" "}
					{vehicleData?.["model"]}
				  </span>{" "}
				  is running{" "}
				  <span class="frontSpacers">
					{vehicleData?.["front-spacer"]}
				  </span>{" "}
				  spacers in the front and{" "}
				  <span class="rearSpacers">
					{vehicleData?.["rear-spacer"]}
				  </span>{" "}
				  spacers in the rear.
				</p>
				<p>
				  With this setup there is{" "}
				  <span class="frontRubbing">
					{vehicleData?.["front-rubbing"]}
				  </span>{" "}
				  in the front and{" "}
				  <span class="rearRubbing">
					{vehicleData?.["rear-rubbing"]}
				  </span>{" "}
				  in the rear. Now, as for fitment - this{" "}
				  <span class="yearMakeModel">
					{vehicleData?.["year"]} {vehicleData?.["make"]}{" "}
					{vehicleData?.["model"]}
				  </span>{" "}
				  has{" "}
				  <span class="stanceType">{vehicleData?.["stance"]}</span>{" "}
				  fitment which we think looks great! Want the same setup for your
				  ride? Check out the exact wheels, tires, and suspension this
				  build is running below and if you like their car, be sure to
				  follow them on their IG and upvote this build to help others
				  find the perfect fitment for{" "}
				  <span class="yearMakeModel">
					{vehicleData?.["year"]} {vehicleData?.["make"]}{" "}
					{vehicleData?.["model"]}
				  </span>{" "}
				  with{" "}
				  <span class="wheelBrand">
					{vehicleData?.["wheel-brand"]}
				  </span>
				  <span class="wheelModel">
					{vehicleData?.["wheel-model"]}
				  </span>{" "}
				  As a reminder - our gallery is curated by our community so
				  please be sure to check a couple of builds to make sure the
				  fitment you want is doable - but if multiple people are doing
				  it, we'd bet you can too!
				</p>
			  </div>
			</div>
		  </div>
		</div>
	  </div>
	  </div>
	</VehicleGalleryLayout>


<script>
	(function () {
		const slider = document.getElementById('vehicle-slider');
		if (!slider) return;
		const trackNode = slider.querySelector('.vehicle-slider__track');
		const slides = slider.querySelectorAll('.vehicle-slider__slide');
		const prev = slider.querySelector('.vehicle-slider__prev');
		const next = slider.querySelector('.vehicle-slider__next');
		const dots = slider.querySelectorAll('.vehicle-slider__dot');
		const total = slides.length;
		if (total <= 1 || !trackNode) return;

		const track = trackNode instanceof HTMLElement ? trackNode : null;
		if (!track) return;

		let index = 0;
		let touchStartX = 0;
		let touchStartY = 0;
		let touchStartIndex = 0;
		let touchIsHorizontal: boolean | null = null;

		function goTo(i: number) {
			index = Math.max(0, Math.min(i, total - 1));
			track!.style.transition = '';
			track!.style.transform = `translate3d(-${index * 100}%, 0, 0)`;
			dots.forEach((dot, j) => {
				dot.setAttribute('aria-selected', j === index ? 'true' : 'false');
				dot.classList.toggle('is-active', j === index);
			});
		}

		prev?.addEventListener('click', () => goTo(index - 1));
		next?.addEventListener('click', () => goTo(index + 1));
		dots.forEach((dot, i) => dot.addEventListener('click', () => goTo(i)));

		track.addEventListener('touchstart', (e: TouchEvent) => {
			if (e.touches.length !== 1) return;
			touchStartX = e.touches[0].clientX;
			touchStartY = e.touches[0].clientY;
			touchStartIndex = index;
			touchIsHorizontal = null;
			track.style.transition = 'none';
		}, { passive: true });

		track.addEventListener('touchmove', (e: TouchEvent) => {
			if (e.touches.length !== 1) return;
			const x = e.touches[0].clientX;
			const y = e.touches[0].clientY;
			const deltaX = x - touchStartX;
			const deltaY = y - touchStartY;
			if (touchIsHorizontal === null) {
				touchIsHorizontal = Math.abs(deltaX) > Math.abs(deltaY);
			}
			if (touchIsHorizontal && Math.abs(deltaX) > 5) {
				e.preventDefault();
			}
			const trackWidth = track.offsetWidth;
			const minOffset = -(total - 1) * trackWidth;
			const maxOffset = 0;
			let offsetPx = -touchStartIndex * trackWidth + deltaX;
			offsetPx = Math.max(minOffset, Math.min(maxOffset, offsetPx));
			track.style.transform = `translate3d(${offsetPx}px, 0, 0)`;
		}, { passive: false });

		track.addEventListener('touchend', (e: TouchEvent) => {
			track.style.transition = '';
			if (e.changedTouches.length !== 1) return;
			const endX = e.changedTouches[0].clientX;
			const deltaX = endX - touchStartX;
			const trackWidth = track.offsetWidth;
			const threshold = trackWidth * 0.2;
			if (deltaX > threshold) {
				goTo(touchStartIndex - 1);
			} else if (deltaX < -threshold) {
				goTo(touchStartIndex + 1);
			} else {
				goTo(touchStartIndex);
			}
		}, { passive: true });

		goTo(0);
	})();
</script>
